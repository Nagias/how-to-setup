import{j as e}from"./vendor-tiptap-CPIgDqZu.js";import{r as u}from"./vendor-react-BadUDqtX.js";import{f as j}from"./index-CQOuJaD9.js";import{u as B}from"./cloudinary-CNrMDq67.js";import"./vendor-firebase-D65FIcPE.js";const se=({onClose:N,onSave:T,initialData:r=null})=>{var R,F,I,$;const[d,M]=u.useState({title:(r==null?void 0:r.title)||"",caption:(r==null?void 0:r.caption)||"",authorName:((R=r==null?void 0:r.author)==null?void 0:R.name)||"",authorAvatar:((F=r==null?void 0:r.author)==null?void 0:F.avatar)||"",filters:(r==null?void 0:r.filters)||{colorTone:"neutral",budget:"mid-range",gender:"neutral",purpose:"productivity",size:"medium"},tags:((I=r==null?void 0:r.tags)==null?void 0:I.join(", "))||""}),[m,C]=u.useState(()=>r!=null&&r.media&&r.media.length>0?r.media:r!=null&&r.image?[{id:Date.now().toString(),type:"image",url:r.image,products:r.products||[]}]:[]),[p,y]=u.useState(null),[w,S]=u.useState(!1),[A,z]=u.useState(null),[b,V]=u.useState((($=r==null?void 0:r.author)==null?void 0:$.avatar)||"");u.useEffect(()=>{m.length>0&&!p&&y(m[0].id)},[m,p]);const c=m.find(s=>s.id===p),[t,h]=u.useState(null),[E,v]=u.useState(!1),P=u.useRef(null),U=(s,l)=>{C(a=>a.map(o=>o.id===s?{...o,...l}:o))},g=s=>{const{name:l,value:a}=s.target;if(l.startsWith("filter.")){const o=l.split(".")[1];M(i=>({...i,filters:{...i.filters,[o]:a}}))}else M(o=>({...o,[l]:a}))},O=s=>{const l=Array.from(s.target.files);if(l.length===0)return;const a=l.map(o=>o.size>10*1024*1024?(alert(`áº¢nh ${o.name} quÃ¡ lá»›n (>10MB).`),null):{id:Date.now()+Math.random().toString(),type:"image",url:URL.createObjectURL(o),file:o,products:[]}).filter(Boolean);C(o=>[...o,...a]),!p&&a.length>0&&y(a[0].id)},X=(s,l)=>{var o;l.stopPropagation();const a=m.filter(i=>i.id!==s);C(a),p===s&&y(((o=a[0])==null?void 0:o.id)||null)},q=s=>{const l=s.target.files[0];if(l){if(l.size>5*1024*1024){alert("Avatar quÃ¡ lá»›n (>5MB).");return}z(l),V(URL.createObjectURL(l))}},G=s=>{if(!c||c.type!=="image")return;const l=P.current.getBoundingClientRect(),a=(s.clientX-l.left)/l.width*100,o=(s.clientY-l.top)/l.height*100,i={id:Date.now().toString(),x:a,y:o,name:"",price:"",link:""};h(i),v(!0)},H=(s,l)=>{s.stopPropagation(),h(l),v(!0)},K=()=>{if(!t.name)return alert("Vui lÃ²ng nháº­p tÃªn sáº£n pháº©m");const s=c.products||[],l=s.find(o=>o.id===t.id);let a;l?a=s.map(o=>o.id===t.id?t:o):a=[...s,t],U(p,{products:a}),h(null),v(!1)},W=()=>{const l=(c.products||[]).filter(a=>a.id!==t.id);U(p,{products:l}),h(null),v(!1)},Y=async s=>{var l,a,o;s.preventDefault(),console.log("ğŸŸ¡ Form submission started"),S(!0);try{if(m.length===0){alert("Vui lÃ²ng thÃªm Ã­t nháº¥t má»™t áº£nh hoáº·c video!"),S(!1);return}console.log("ğŸŸ¡ Processing media uploads...");let i=b;if(A)try{console.log("ğŸŸ¡ Uploading avatar to Cloudinary..."),i=(await B(A,"avatars")).url,console.log("âœ… Avatar uploaded to Cloudinary:",i)}catch(n){console.error("âŒ Avatar upload failed:",n),i="https://ui-avatars.com/api/?name="+encodeURIComponent(d.authorName||"User")}const x=await Promise.all(m.map(async n=>{if(n.file)try{console.log(`ğŸŸ¡ Uploading image to Cloudinary: ${n.file.name}`);const f=await B(n.file,"desk-setups");return console.log("âœ… Image uploaded to Cloudinary:",f.url),{...n,url:f.url,file:null}}catch(f){throw console.error("âŒ Image upload failed:",f),new Error(`KhÃ´ng thá»ƒ táº£i áº£nh "${n.file.name}": ${f.message}`)}return n}));console.log("ğŸŸ¡ Media processing complete:",x);const J=d.tags.split(",").map(n=>n.trim()).filter(n=>n),L=x.filter(n=>n.type==="image").map(n=>({url:n.url,products:n.products||[]})),k={title:d.caption.substring(0,50)||"Setup",caption:d.caption,filters:d.filters,tags:J,author:{name:d.authorName||"Anonymous",avatar:i||"https://ui-avatars.com/api/?name="+encodeURIComponent(d.authorName||"User")},images:L,media:x,mainImage:((l=x[0])==null?void 0:l.url)||"",image:((a=x[0])==null?void 0:a.url)||"",products:((o=L[0])==null?void 0:o.products)||[],updatedAt:new Date().toISOString()};console.log("ğŸŸ¡ Final setupData to save:",k),console.log("ğŸŸ¡ Calling onSave..."),r!=null&&r.id?await T(r.id,k):await T(k),console.log("âœ… onSave completed successfully")}catch(i){console.error("âŒ Form submission error:",i),alert(i.message||"CÃ³ lá»—i xáº£y ra khi lÆ°u setup.")}finally{S(!1)}};return e.jsx("div",{className:"modal-overlay",onClick:N,children:e.jsxs("div",{className:"modal-content add-setup-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:r?"Chá»‰nh Sá»­a Setup":"ThÃªm GÃ³c Setup Má»›i"}),e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center"},children:[w&&e.jsx("span",{style:{color:"var(--accent-color)"},children:"â³ Äang táº£i lÃªn... Vui lÃ²ng chá»"}),e.jsx("button",{className:"close-btn",onClick:N,children:"Ã—"})]})]}),e.jsx("div",{className:"add-setup-body",children:e.jsxs("form",{id:"setupForm",onSubmit:Y,className:"setup-form-layout",children:[e.jsxs("div",{className:"form-column",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"MÃ´ táº£"}),e.jsx("textarea",{name:"caption",value:d.caption,onChange:g,required:!0,placeholder:"MÃ´ táº£ vá» gÃ³c setup nÃ y...",rows:"4"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Media (áº¢nh/Video)"}),e.jsxs("div",{className:"media-gallery-preview",children:[m.map(s=>e.jsxs("div",{className:`media-thumb ${p===s.id?"active":""}`,onClick:()=>y(s.id),children:[s.type==="video"&&s.platform==="youtube"?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s.thumb||s.thumbnail,alt:"yt-thumb",style:{opacity:.8}}),e.jsx("div",{className:"video-icon",style:{fontSize:"12px"},children:"ğŸ”´"})]}):s.type==="video"?e.jsx("div",{className:"video-icon",children:"â–¶ï¸"}):e.jsx("img",{src:s.url,alt:"thumb"}),e.jsx("button",{type:"button",className:"btn-remove-media",onClick:l=>X(s.id,l),children:"Ã—"})]},s.id)),e.jsxs("label",{className:"add-media-btn",children:[e.jsx("input",{type:"file",multiple:!0,accept:"image/*,video/*",onChange:O,style:{display:"none"}}),e.jsx("span",{children:"+ ThÃªm"})]})]}),e.jsx("small",{style:{display:"block",marginTop:"5px",color:"#888"},children:"Há»— trá»£ tá»‘i Ä‘a 8 áº£nh (Max 10MB/áº£nh)."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"TÃªn ngÆ°á»i Ä‘Äƒng"}),e.jsx("input",{type:"text",name:"authorName",value:d.authorName,onChange:g,placeholder:"Nháº­p tÃªn ngÆ°á»i Ä‘Äƒng..."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Avatar ngÆ°á»i Ä‘Äƒng"}),e.jsxs("div",{style:{display:"flex",gap:"10px",alignItems:"center"},children:[b&&e.jsx("img",{src:b,alt:"Avatar preview",style:{width:"60px",height:"60px",borderRadius:"50%",objectFit:"cover",border:"2px solid var(--color-border)"}}),e.jsxs("label",{className:"btn btn-secondary",style:{cursor:"pointer",margin:0},children:[e.jsx("input",{type:"file",accept:"image/*",onChange:q,style:{display:"none"}}),b?"Äá»•i Avatar":"Táº£i Avatar"]})]}),e.jsx("small",{style:{display:"block",marginTop:"5px",color:"#888"},children:"áº¢nh Ä‘áº¡i diá»‡n cá»§a ngÆ°á»i Ä‘Äƒng (Max 5MB)"})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"TÃ´ng mÃ u"}),e.jsx("select",{name:"filter.colorTone",value:d.filters.colorTone,onChange:g,children:j.colorTone.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"NgÃ¢n sÃ¡ch"}),e.jsx("select",{name:"filter.budget",value:d.filters.budget,onChange:g,children:j.budget.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Phong cÃ¡ch"}),e.jsx("select",{name:"filter.gender",value:d.filters.gender,onChange:g,children:j.gender.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Má»¥c Ä‘Ã­ch"}),e.jsx("select",{name:"filter.purpose",value:d.filters.purpose,onChange:g,children:j.purpose.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"KhÃ´ng gian"}),e.jsx("select",{name:"filter.size",value:d.filters.size,onChange:g,children:j.size.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Tags (ngÄƒn cÃ¡ch bá»Ÿi dáº¥u pháº©y)"}),e.jsx("input",{type:"text",name:"tags",value:d.tags,onChange:g,placeholder:"gaming, minimal, rgb..."})]})]})]}),e.jsxs("div",{className:"form-column",children:[e.jsx("label",{style:{marginBottom:"0.5rem",display:"block",fontWeight:"500"},children:c?c.type==="video"||c.type==="youtube"?"Xem Video (KhÃ´ng há»— trá»£ gáº¯n tháº»)":"Gáº¯n Tháº» Sáº£n Pháº©m (Click vÃ o áº£nh)":"Xem trÆ°á»›c"}),e.jsx("div",{className:"image-tagging-area",children:c?c.type==="video"?e.jsx("video",{src:c.url,controls:!0,className:"tagging-image",style:{maxHeight:"100%"}}):c.type==="youtube"?e.jsx("iframe",{width:"100%",height:"100%",src:c.url,title:"YouTube video player",frameBorder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0,style:{aspectRatio:"16/9",borderRadius:"8px"}}):e.jsxs("div",{className:"image-wrapper",ref:P,onClick:G,children:[e.jsx("img",{src:c.url,alt:"Tagging Area",className:"tagging-image"}),c.products.map(s=>e.jsx("div",{className:`tag-marker ${(t==null?void 0:t.id)===s.id?"active":""}`,style:{left:`${s.x}%`,top:`${s.y}%`},onClick:l=>H(l,s),children:"+"},s.id)),t&&!c.products.find(s=>s.id===t.id)&&e.jsx("div",{className:"tag-marker active",style:{left:`${t.x}%`,top:`${t.y}%`},children:" + "}),E&&t&&e.jsxs("div",{className:"tag-popup",style:{left:`${Math.min(t.x,60)}%`,top:`${Math.min(t.y+5,80)}%`},onClick:s=>s.stopPropagation(),children:[e.jsx("h4",{children:c.products.find(s=>s.id===t.id)?"Sá»­a Sáº£n Pháº©m":"ThÃªm Sáº£n Pháº©m"}),e.jsx("div",{className:"form-group",children:e.jsx("input",{autoFocus:!0,placeholder:"TÃªn sáº£n pháº©m",value:t.name,onChange:s=>h({...t,name:s.target.value})})}),e.jsx("div",{className:"form-group",children:e.jsx("input",{placeholder:"GiÃ¡",value:t.price,onChange:s=>h({...t,price:s.target.value})})}),e.jsx("div",{className:"form-group",children:e.jsx("input",{placeholder:"Link (tÃ¹y chá»n)",value:t.link,onChange:s=>h({...t,link:s.target.value})})}),e.jsxs("div",{className:"popup-actions",children:[e.jsx("button",{type:"button",className:"btn-small btn-delete",onClick:()=>{c.products.find(s=>s.id===t.id)?W():(h(null),v(!1))},children:"XÃ³a"}),e.jsx("button",{type:"button",className:"btn-small btn-submit",onClick:K,children:"LÆ°u"})]})]})]}):e.jsx("div",{className:"placeholder-text",children:"Chá»n hoáº·c táº£i lÃªn media Ä‘á»ƒ báº¯t Ä‘áº§u custom"})})]})]})}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"btn-cancel",onClick:N,children:"Há»§y"}),e.jsx("button",{type:"submit",form:"setupForm",className:"btn-submit",disabled:w,children:w?"Äang Upload...":"ÄÄƒng Setup"})]})]})})};export{se as default};
